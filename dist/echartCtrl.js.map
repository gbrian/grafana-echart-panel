{"version":3,"sources":["../src/echartCtrl.js"],"names":["MetricsPanelCtrl","_","kbn","TimeSeries","config","EChartRendering","AceEditorTabCtrl","EChartOptions","HtmlTemplate","HtmlJSTemplate","HtmlCSSTemplate","EChartCtrl","$scope","$injector","$rootScope","templateSrv","hiddenSeries","panelDefaults","links","interval","cacheTimeout","nullPointMode","legendType","breakPoint","aliasColors","format","valueName","strokeWidth","fontSize","combine","threshold","label","html","htmlJS","htmlCSS","eoptions","echartError","defaults","panel","events","on","onRender","bind","onDataReceived","onDataError","onInitEditMode","onInitPanelActions","setLegendWidthForLegacyBrowser","bootData","user","lightTheme","actions","push","text","click","scope","$new","seriesList","data","series","publishAppEvent","templateHtml","modalClass","initTab","tabs","dataPreviewGetSet","htmlPreviewGetSet","jsPreviewGetSet","cssPreviewGetSet","optionsPreviewGetSet","map","kv","ix","addEditorTab","unitFormats","getUnitFormats","buildDirective","val","undefined","JSON","parse","stringify","editor","session","foldAll","subItem","value","render","color","alias","markup","replaceVariables","url","fnc","Function","res","asset","then","Promise","resolve","e","reject","serie","i","stats","colors","legendData","dataList","seriesHandler","filter","r","parsed","parseSeries","raw","table","tableHandler","jsdata","seriesData","columns","c","rows","reduce","acc","v","datapoints","target","flotpairs","getFlotPairs","isNumber","decimals","scaledDecimals","delta","dec","Math","floor","log","LN10","magn","pow","norm","size","result","max","decimalInfo","getDecimalsForValue","formatFunc","valueFormats","elem","attrs","ctrl","rendering","isIE11","window","MSInputMethodContext","document","documentMode","legend","sideWidth","id","replace","getPanelIdCSS","internalReplace","scopedVars","templateUrl"],"mappings":"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","file":"echartCtrl.js","sourcesContent":["import {MetricsPanelCtrl} from 'app/plugins/sdk';\nimport _ from 'lodash';\nimport kbn from 'app/core/utils/kbn';\nimport TimeSeries from 'app/core/time_series';\nimport config from 'app/core/config';\nimport EChartRendering from './rendering';\nimport AceEditorTabCtrl from './tabs/AceEditorTabCtrl';\nimport EChartOptions from './tabs/echarttpl';\nimport HtmlTemplate from './tabs/htmltpl';\nimport HtmlJSTemplate from './tabs/htmljstpl';\nimport HtmlCSSTemplate from './tabs/csstpl';\n\nexport class EChartCtrl extends MetricsPanelCtrl {\n\n  constructor($scope, $injector, $rootScope, templateSrv) {\n    super($scope, $injector);\n    this.$rootScope = $rootScope;\n    this.hiddenSeries = {};\n    this.templateSrv = templateSrv;\n\n    var panelDefaults = {\n      links: [],\n      interval: null,\n      cacheTimeout: null,\n      nullPointMode: 'connected',\n      legendType: 'Under graph',\n      breakPoint: '50%',\n      aliasColors: {},\n      format: 'short',\n      valueName: 'current',\n      strokeWidth: 1,\n      fontSize: '80%',\n      combine: {\n        threshold: 0.0,\n        label: 'Others'\n      },\n      html: HtmlTemplate(),\n      htmlJS: HtmlJSTemplate(),\n      htmlCSS: HtmlCSSTemplate(),\n      eoptions: EChartOptions(),\n      echartError: ''\n    };\n\n    _.defaults(this.panel, panelDefaults);\n    \n    this.events.on('render', this.onRender.bind(this));\n    this.events.on('data-received', this.onDataReceived.bind(this));\n    this.events.on('data-error', this.onDataError.bind(this));\n    this.events.on('data-snapshot-load', this.onDataReceived.bind(this));\n    this.events.on('init-edit-mode', this.onInitEditMode.bind(this));\n    this.events.on('init-panel-actions', this.onInitPanelActions.bind(this));\n\n    this.setLegendWidthForLegacyBrowser();\n  }\n\n  getTheme(){\n    return config.bootData.user.lightTheme ? 'light': 'dark';\n  }\n\n  onInitPanelActions(actions) {\n    actions.push({ text: 'Export CSV', click: 'ctrl.exportCsv()' });\n  }\n\n  exportCsv() {\n    const scope = this.$scope.$new(true);\n    scope.seriesList = this.data.series;\n    this.publishAppEvent('show-modal', {\n      templateHtml: '<export-data-modal data=\"seriesList\"></export-data-modal>',\n      scope,\n      modalClass: 'modal--narrow',\n    });\n  }\n\n  onInitEditMode() {\n    var initTab = 2;\n    var tabs = [\n      ['Data', this.dataPreviewGetSet()],\n      ['HTML', this.htmlPreviewGetSet()],\n      ['JS', this.jsPreviewGetSet()],\n      ['CSS', this.cssPreviewGetSet()],\n      ['EChart options', this.optionsPreviewGetSet()]];\n    _.map(tabs,\n      (kv, ix) => this.addEditorTab(kv[0], kv[1], initTab+ix));\n\n    this.unitFormats = kbn.getUnitFormats();\n  }\n\n  dataPreviewGetSet(){\n    return AceEditorTabCtrl.buildDirective('json', val => {\n        if(val !== undefined)\n          this.data = JSON.parse(val);\n        return JSON.stringify(this.data, null, 2);\n    },\n    (editor, session) => session.foldAll(1));\n  }\n  htmlPreviewGetSet(){\n    return AceEditorTabCtrl.buildDirective('html', val => {\n        if(val !== undefined)\n          this.panel.html = val;\n        return this.panel.html;\n    });\n  }\n  jsPreviewGetSet(){\n    return AceEditorTabCtrl.buildDirective('javascript', val => {\n        if(val !== undefined)\n          this.panel.htmlJS = val;\n        return this.panel.htmlJS;\n    });\n  }\n  cssPreviewGetSet(){\n    return AceEditorTabCtrl.buildDirective('css', val => {\n        if(val !== undefined)\n          this.panel.htmlCSS = val;\n        return this.panel.htmlCSS;\n    });\n  }\n  optionsPreviewGetSet(){\n    return AceEditorTabCtrl.buildDirective('javascript', val => {\n        if(val !== undefined)\n          this.panel.eoptions = val;\n        return this.panel.eoptions;\n    });\n  }\n  setUnitFormat(subItem) {\n    this.panel.format = subItem.value;\n    this.render();\n  }\n\n  onDataError() {\n    this.onDataReceived([]);\n    this.render();\n  }\n\n  changeSeriesColor(series, color) {\n    series.color = color;\n    this.panel.aliasColors[series.alias] = series.color;\n    this.render();\n  }\n\n  onRender() {\n    // this.data = this.parseSeries(this.series);\n  }\n\n  getChartMarkup(){\n    var markup = this.panel.html+\n                 `<script type=\"text/javascript\">${this.panel.htmlJS}</script>`+\n                 `<style>${this.panel.htmlCSS}</style>`;\n    return this.replaceVariables(markup);\n  }\n  \n  asset(url){\n    return `/public/plugins/grafana-echart-panel/lib/${url}`;\n  }\n\n  getChartOptions(){\n    try{\n      var eoptions = this.replaceVariables(this.panel.eoptions);\n      var fnc = new Function(\"return \" + eoptions)();\n      var res = fnc.bind(this)(this.data, this.asset.bind(this));\n      return (res && res.then) ? res: Promise.resolve(res);\n    }catch(e){\n      return Promise.reject(e);\n    }\n  }\n\n  parseSeries(series) {\n    return _.map(series, (serie, i) => {\n      return {\n        label: serie.alias,\n        data: serie.stats[this.panel.valueName],\n        color: this.panel.aliasColors[serie.alias] || this.$rootScope.colors[i],\n        legendData: serie.stats[this.panel.valueName],\n      };\n    });\n  }\n\n  onDataReceived(dataList) {\n    var series = _.map(dataList, this.seriesHandler.bind(this))\n                    .filter(r => r);\n    var parsed = this.parseSeries(series);\n    this.data = {\n        raw: dataList,\n        series: series,\n        parsed: parsed,\n        table: _.map(dataList, this.tableHandler.bind(this))\n    };\n    this.jsdata = JSON.stringify(this.data, null, 2);\n    this.render(this.data);\n  }\n\n  tableHandler(seriesData){\n    if(!seriesData.columns)\n      return []\n    var columns = _.map(seriesData.columns, c => c.text);\n    return _.map(seriesData.rows, r => columns.reduce((acc, v, ix) => acc[v] = r[ix] ,{}));\n  }\n\n  seriesHandler(seriesData) {\n    if(!seriesData.datapoints) \n      return null;\n\n    var series = new TimeSeries({\n      datapoints: seriesData.datapoints,\n      alias: seriesData.target\n    });\n\n    series.flotpairs = series.getFlotPairs(this.panel.nullPointMode);\n    return series;\n  }\n\n  getDecimalsForValue(value) {\n    if (_.isNumber(this.panel.decimals)) {\n      return { decimals: this.panel.decimals, scaledDecimals: null };\n    }\n\n    var delta = value / 2;\n    var dec = -Math.floor(Math.log(delta) / Math.LN10);\n\n    var magn = Math.pow(10, -dec);\n    var norm = delta / magn; // norm is between 1.0 and 10.0\n    var size;\n\n    if (norm < 1.5) {\n      size = 1;\n    } else if (norm < 3) {\n      size = 2;\n      // special case for 2.5, requires an extra decimal\n      if (norm > 2.25) {\n        size = 2.5;\n        ++dec;\n      }\n    } else if (norm < 7.5) {\n      size = 5;\n    } else {\n      size = 10;\n    }\n\n    size *= magn;\n\n    // reduce starting decimals if not needed\n    if (Math.floor(value) === value) { dec = 0; }\n\n    var result = {};\n    result.decimals = Math.max(0, dec);\n    result.scaledDecimals = result.decimals - Math.floor(Math.log(size) / Math.LN10) + 2;\n\n    return result;\n  }\n\n  formatValue(value) {\n    var decimalInfo = this.getDecimalsForValue(value);\n    var formatFunc = kbn.valueFormats[this.panel.format];\n    if (formatFunc) {\n      return formatFunc(value, decimalInfo.decimals, decimalInfo.scaledDecimals);\n    }\n    return value;\n  }\n\n  link(scope, elem, attrs, ctrl) {\n    ctrl.elem = elem;\n    this.rendering = new EChartRendering(scope, elem, attrs, ctrl);\n  }\n\n  toggleSeries(serie) {\n    if (this.hiddenSeries[serie.label]) {\n      delete this.hiddenSeries[serie.label];\n    } else {\n      this.hiddenSeries[serie.label] = true;\n    }\n    this.render();\n  }\n\n  onLegendTypeChanged() {\n    this.setLegendWidthForLegacyBrowser();\n    this.render();\n  }\n\n  setLegendWidthForLegacyBrowser() {\n    var isIE11 = !!window.MSInputMethodContext && !!document.documentMode;\n    if (isIE11 && this.panel.legendType === 'Right side' && !this.panel.legend.sideWidth) {\n      this.panel.legend.sideWidth = 150;\n    }\n  }\n  getPanelIdCSS(){\n    return `panel_markup_${this.panel.id}`;\n  }\n  internalReplace(text){\n    return text.replace(/\\$__[a-zA-Z0-9_]+/g, v =>{\n      switch(v){\n        case \"$__panelId\":\n          return this.getPanelIdCSS();\n      }\n      return v;\n    });\n  }\n  replaceVariables(text){\n    if(text){\n      text = this.internalReplace(text);\n      text = this.templateSrv.replace(text, this.panel.scopedVars);\n    }\n    return text;\n  }\n}\n\nEChartCtrl.templateUrl = 'module.html';\n"]}