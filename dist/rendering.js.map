{"version":3,"sources":["../src/rendering.js"],"names":["_","$","appEvents","contextSrv","d3","echart_panel__chart_class","EChartRendering","scope","elem","attrs","ctrl","panel","init","events","on","onRender","bind","loadPlugins","onGraphHover","onGraphHoverClear","e","console","error","clearCrosshair","echart","dispatchAction","type","getTimeAxis","getOption","xAxis","filter","x","event","sharesToolTip","dashboard","sharedTooltipModeEnabled","id","otherPanelInFullscreenMode","graphTooltip","drawSharedCrosshair","pos","posX","xScale","posY","offset","top","height","panelRelY","y","src","endsWith","createScript","createLink","append","plugins","p","length","map","loadAsset","html","find","remove","initEchart","getChartOptions","then","options","setOption","resize","scaleTime","domain","range","from","to","getWidth","notify","data","echartError","catch","toString","stack","text","markupDom","jchart","is","echarts","getTheme","renderer","render","markup","getChartMarkup","lastMarkup","jmarkup","resetNotify","empty","log","getPanelIdCSS","off","trigger","incrementRenderCounter","raw","noDataPoints","undefined","setTimeout","clearWarning","initMarkup","addechart","renderingCompleted"],"mappings":"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","file":"rendering.js","sourcesContent":["import _ from 'lodash';\nimport $ from 'jquery';\nimport 'jquery.flot';\nimport 'jquery.flot.pie';\nimport './lib/jquery.json-editor.min';\nimport { appEvents, contextSrv } from 'app/core/core';\nimport * as d3 from 'd3';\n\nconst echart_panel__chart_class = '.echart-panel__chart';\n\nexport default class EChartRendering {\n  constructor(scope, elem, attrs, ctrl) {\n    this.panel = ctrl.panel;\n    this.elem = elem;\n    this.ctrl = ctrl;\n    this.scope = scope;\n    this.init();\n  }\n\n  init() {\n    this.ctrl.events.on('render', this.onRender.bind(this));\n    try {\n      this.loadPlugins();\n      // Shared crosshair and tooltip\n      appEvents.on('graph-hover', this.onGraphHover.bind(this), this.scope);\n      appEvents.on('graph-hover-clear', this.onGraphHoverClear.bind(this), this.scope);\n    } catch (e) {\n      console.error(e);\n    }\n  }\n\n  onGraphHoverClear() {\n    this.clearCrosshair();\n  }\n  clearCrosshair() {\n    this.echart.dispatchAction({\n      type: 'hideTip'\n    });\n  }\n\n  sharesToolTip() {\n    return !!this.getTimeAxis();\n  }\n\n  getTimeAxis() {\n    return this.echart.getOption()\n      .xAxis\n      .filter(x => x.type === \"time\")[0];\n  }\n\n  onGraphHover(event) {\n    // ignore other graph hover events if shared tooltip is disabled\n    if (this.sharesToolTip() && !this.ctrl.dashboard.sharedTooltipModeEnabled()) {\n      return;\n    }\n\n    // ignore if we are the emitter\n    if (event.panel.id === this.panel.id || this.ctrl.otherPanelInFullscreenMode()) {\n      return;\n    }\n    if (this.ctrl.dashboard.graphTooltip !== 0) {\n      this.drawSharedCrosshair(event.pos);\n    }\n  }\n\n  drawSharedCrosshair(pos) {\n    var posX = this.xScale(pos.x);\n    var posY = this.elem.offset().top + (this.elem.height() * pos.panelRelY);\n    this.echart.dispatchAction({\n      type: 'showTip',\n      x: posX,\n      y: posY\n    })\n  }\n\n  loadAsset(id, src) {\n    src.endsWith(\".js\") ?\n      this.createScript(id, src) :\n      this.createLink(id, src);\n  }\n\n  createLink(id, src) {\n    $('head').append(`<link rel=\"stylesheet\" id=\"${id}\" href=\"${src}\">`);\n  }\n\n  createScript(id, src) {\n    $('head').append(`<script type=\"text/javascript\" id=\"${id}\" src=\"${src}\"></script>`);\n  }\n\n  loadPlugins() {\n    // TODO: Fix dependencies plugins load\n    const plugins = [\n      { id: 'echarts', src: '/public/plugins/grafana-echart-panel/lib/echarts/echarts.min.js' },\n      { id: 'liquidfill', src: '/public/plugins/grafana-echart-panel/lib/echarts/liquidfill.min.js' },\n      { id: 'zrender', src: '/public/plugins/grafana-echart-panel/lib/echarts/zrender.min.js' },\n      { id: 'claygl', src: '/public/plugins/grafana-echart-panel/lib/echarts/claygl.min.js' },\n      { id: 'echarts-gl', src: '/public/plugins/grafana-echart-panel/lib/echarts/echarts-gl.min.js' },\n      { id: 'moment', src: '/public/plugins/grafana-echart-panel/lib/moment.min.js'}\n    ];\n    plugins.filter(p => $(`#${p.id}`).length === 0)\n      .map(p => this.loadAsset(p.id, p.src));\n  }\n\n  noDataPoints() {\n    var html = '<div class=\"datapoints-warning\"><span class=\"small\">No data points</span></div>';\n    this.elem.append(html);\n  }\n\n  clearWarning() {\n    this.elem.find('.datapoints-warning').remove();\n  }\n\n  addechart() {\n    if (!this.initEchart()) return;\n    this.ctrl.getChartOptions()\n      .then(options => {\n        if(!options) return;\n        this.echart.setOption(options, true);\n        this.echart.resize();\n        this.xScale = d3\n          .scaleTime()\n          .domain([this.ctrl.range.from, this.ctrl.range.to])\n          .range([0, this.echart.getWidth()]);\n        this.notify('echart-changed',\n          { data: this.ctrl.data, echart: this.echart, options: options });\n        this.panel.echartError = \"\";\n      })\n      .catch(e => {\n        console.error(e);\n        this.panel.echartError = `${e.toString()}\\r${e.stack}`;\n      });\n    this.elem.find('.echart-error').text(this.panel.echartError);\n  }\n\n  initEchart() {\n    var markupDom = this.markupDom();\n    var jchart = markupDom.is(echart_panel__chart_class) ?\n      markupDom : markupDom.find(echart_panel__chart_class);\n    if (!jchart.length) {\n      return null;\n    }\n    if (!this.echart || !$(`[_echarts_instance_=\"${this.echart.id}\"]`).length) {\n      this.echart = echarts.init(jchart[0],\n        this.ctrl.getTheme(), {\n          renderer: this.panel.renderer || 'canvas'\n        });\n    }\n    return this.echart;\n  }\n\n  onRender() {\n    this.render(false);\n  }\n\n  initMarkup() {\n    var markup = this.ctrl.getChartMarkup();\n    if (markup === this.lastMarkup)\n      return;\n    try {\n      var jmarkup = $(markup);\n      this.resetNotify('init-markup');\n      this.resetNotify('data-changed');\n      this.resetNotify('echart-changed');\n      this.elem.find('.echart-panel__html')\n        .empty()\n        .html(jmarkup);\n      this.notify('init-markup', { data: this.ctrl.data });\n      this.lastMarkup = markup;\n    } catch (e) {\n      console.log(e);\n    }\n  }\n\n  markupDom() {\n    return $(`#${this.ctrl.getPanelIdCSS()}`);\n  }\n\n  resetNotify(type) {\n    this.markupDom().off(type);\n  }\n  notify(type, data) {\n    this.markupDom().trigger(type, data);\n  }\n\n  render(incrementRenderCounter) {\n    if (!this.ctrl.data || !this.ctrl.data.raw.length) {\n      this.noDataPoints()\n      return;\n    }\n    if (echarts === undefined ||\n      echarts.init === undefined) {\n      setTimeout(() => this.render(incrementRenderCounter), 500);\n      return;\n    }\n\n    this.clearWarning();\n    this.initMarkup();\n    this.notify('data-changed', { data: this.ctrl.data });\n    this.addechart();\n\n    if (incrementRenderCounter) {\n      this.ctrl.renderingCompleted();\n    }\n  }\n}\n"]}